<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - <%= siteName %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <%- include('../../partials/header') %>

    <div class="container-fluid py-4">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 px-0">
                <%- include('../partials/sidebar', { currentPage: 'resultats' }) %>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 px-4">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/admin/dashboard">Dashboard</a></li>
                        <li class="breadcrumb-item"><a href="/admin/resultats">Résultats</a></li>
                        <li class="breadcrumb-item active"><%= result ? 'Modifier' : 'Nouveau résultat' %></li>
                    </ol>
                </nav>

                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="fw-bold"><%= result ? 'Modifier le résultat' : 'Nouveau résultat' %></h2>
                    <a href="/admin/resultats" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-2"></i>Retour
                    </a>
                </div>

                <form method="POST" action="<%= result ? '/admin/resultats/' + result._id + '/modifier' : '/admin/resultats/nouveau' %>">
                    <div class="row">
                        <div class="col-lg-8">
                            <!-- Informations de la compétition -->
                            <div class="card shadow-sm mb-4">
                                <div class="card-header bg-white">
                                    <h5 class="mb-0">Compétition</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-12">
                                            <label for="competitionName" class="form-label">Nom de la compétition *</label>
                                            <input type="text" class="form-control" id="competitionName" name="competitionName"
                                                   value="<%= result?.competition?.name || '' %>" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="competitionDate" class="form-label">Date *</label>
                                            <input type="date" class="form-control" id="competitionDate" name="competitionDate"
                                                   value="<%= result?.competition?.date ? new Date(result.competition.date).toISOString().split('T')[0] : '' %>" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="competitionLocation" class="form-label">Lieu</label>
                                            <input type="text" class="form-control" id="competitionLocation" name="competitionLocation"
                                                   value="<%= result?.competition?.location || '' %>">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="competitionLevel" class="form-label">Niveau</label>
                                            <select class="form-select" id="competitionLevel" name="competitionLevel">
                                                <option value="">Sélectionner</option>
                                                <option value="local" <%= result?.competition?.level === 'local' ? 'selected' : '' %>>Local</option>
                                                <option value="regional" <%= result?.competition?.level === 'regional' ? 'selected' : '' %>>Régional</option>
                                                <option value="national" <%= result?.competition?.level === 'national' ? 'selected' : '' %>>National</option>
                                                <option value="international" <%= result?.competition?.level === 'international' ? 'selected' : '' %>>International</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="discipline" class="form-label">Discipline *</label>
                                            <select class="form-select" id="discipline" name="discipline" required>
                                                <option value="">Sélectionner</option>
                                                <option value="pistolet" <%= result?.discipline === 'pistolet' ? 'selected' : '' %>>Pistolet</option>
                                                <option value="carabine" <%= result?.discipline === 'carabine' ? 'selected' : '' %>>Carabine</option>
                                                <option value="tir-sportif" <%= result?.discipline === 'tir-sportif' ? 'selected' : '' %>>Tir sportif</option>
                                            </select>
                                        </div>
                                        <div class="col-12">
                                            <label for="category" class="form-label">Catégorie</label>
                                            <input type="text" class="form-control" id="category" name="category"
                                                   value="<%= result?.category || '' %>"
                                                   placeholder="Ex: Senior, Junior, Vétéran">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Classement -->
                            <div class="card shadow-sm mb-4">
                                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Classement individuel</h5>
                                    <button type="button" class="btn btn-sm btn-primary" onclick="addRanking()">
                                        <i class="bi bi-plus-circle me-1"></i>Ajouter
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div id="rankingsContainer">
                                        <% if (result?.rankings && result.rankings.length > 0) { %>
                                            <% result.rankings.forEach((ranking, index) => { %>
                                                <div class="ranking-item border rounded p-3 mb-3">
                                                    <div class="row g-2">
                                                        <div class="col-md-2">
                                                            <label class="form-label small">Position</label>
                                                            <input type="number" class="form-control" name="rankings[<%= index %>][position]"
                                                                   value="<%= ranking.position %>" required>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <label class="form-label small">Athlète</label>
                                                            <select class="form-select" name="rankings[<%= index %>][athlete]">
                                                                <option value="">Autre</option>
                                                                <% athletes.forEach(athlete => { %>
                                                                    <option value="<%= athlete._id %>"
                                                                            <%= ranking.athlete && ranking.athlete.toString() === athlete._id.toString() ? 'selected' : '' %>>
                                                                        <%= athlete.firstName %> <%= athlete.lastName %>
                                                                    </option>
                                                                <% }); %>
                                                            </select>
                                                        </div>
                                                        <div class="col-md-3">
                                                            <label class="form-label small">Nom (si autre)</label>
                                                            <input type="text" class="form-control" name="rankings[<%= index %>][athleteName]"
                                                                   value="<%= ranking.athleteName || '' %>">
                                                        </div>
                                                        <div class="col-md-2">
                                                            <label class="form-label small">Score</label>
                                                            <input type="text" class="form-control" name="rankings[<%= index %>][score]"
                                                                   value="<%= ranking.score || '' %>">
                                                        </div>
                                                        <div class="col-md-1 d-flex align-items-end">
                                                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRanking(this)">
                                                                <i class="bi bi-trash"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            <% }); %>
                                        <% } else { %>
                                            <div class="text-muted text-center py-3">
                                                Aucun classement. Cliquez sur "Ajouter" pour commencer.
                                            </div>
                                        <% } %>
                                    </div>
                                </div>
                            </div>

                            <!-- Notes et liens -->
                            <div class="card shadow-sm mb-4">
                                <div class="card-header bg-white">
                                    <h5 class="mb-0">Informations complémentaires</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="reportLink" class="form-label">Lien du rapport officiel</label>
                                        <input type="url" class="form-control" id="reportLink" name="reportLink"
                                               value="<%= result?.reportLink || '' %>"
                                               placeholder="https://...">
                                    </div>
                                    <div class="mb-3">
                                        <label for="notes" class="form-label">Notes</label>
                                        <textarea class="form-control" id="notes" name="notes" rows="4"><%= result?.notes || '' %></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sidebar -->
                        <div class="col-lg-4">
                            <!-- Statut -->
                            <div class="card shadow-sm mb-4">
                                <div class="card-header bg-white">
                                    <h6 class="mb-0">Statut</h6>
                                </div>
                                <div class="card-body">
                                    <select class="form-select" name="status">
                                        <option value="provisional" <%= !result || result.status === 'provisional' ? 'selected' : '' %>>Provisoire</option>
                                        <option value="final" <%= result?.status === 'final' ? 'selected' : '' %>>Final</option>
                                        <option value="unofficial" <%= result?.status === 'unofficial' ? 'selected' : '' %>>Non officiel</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Actions -->
                            <div class="card shadow-sm">
                                <div class="card-body">
                                    <div class="d-grid gap-2">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-check-circle me-2"></i><%= result ? 'Mettre à jour' : 'Enregistrer' %>
                                        </button>
                                        <a href="/admin/resultats" class="btn btn-outline-secondary">Annuler</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let rankingIndex = <%= result?.rankings?.length || 0 %>;

        function addRanking() {
            const container = document.getElementById('rankingsContainer');

            // Supprimer le message "Aucun classement" s'il existe
            const emptyMessage = container.querySelector('.text-muted');
            if (emptyMessage) {
                emptyMessage.remove();
            }

            const rankingHtml = `
                <div class="ranking-item border rounded p-3 mb-3">
                    <div class="row g-2">
                        <div class="col-md-2">
                            <label class="form-label small">Position</label>
                            <input type="number" class="form-control" name="rankings[${rankingIndex}][position]" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small">Athlète</label>
                            <select class="form-select" name="rankings[${rankingIndex}][athlete]">
                                <option value="">Autre</option>
                                <% athletes.forEach(athlete => { %>
                                    <option value="<%= athlete._id %>"><%= athlete.firstName %> <%= athlete.lastName %></option>
                                <% }); %>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">Nom (si autre)</label>
                            <input type="text" class="form-control" name="rankings[${rankingIndex}][athleteName]">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small">Score</label>
                            <input type="text" class="form-control" name="rankings[${rankingIndex}][score]">
                        </div>
                        <div class="col-md-1 d-flex align-items-end">
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRanking(this)">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', rankingHtml);
            rankingIndex++;
        }

        function removeRanking(button) {
            const rankingItem = button.closest('.ranking-item');
            rankingItem.remove();

            // Afficher le message si plus de classements
            const container = document.getElementById('rankingsContainer');
            if (container.children.length === 0) {
                container.innerHTML = '<div class="text-muted text-center py-3">Aucun classement. Cliquez sur "Ajouter" pour commencer.</div>';
            }
        }
    </script>
</body>
</html>
